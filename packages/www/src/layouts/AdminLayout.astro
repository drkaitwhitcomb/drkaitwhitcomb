---
import BaseLayout from "@/layouts/BaseLayout.astro";

const configuration = {
  src: "/keystatic",
  title: "Admin",
};
---

<BaseLayout title={configuration.title}>
  <section style="height: 100dvh; display: grid; grid-template-rows: 1fr;">
    <iframe
      src={configuration.src}
      title={configuration.title}
      loading="eager"
      referrerpolicy="same-origin"
      sandbox="allow-scripts allow-same-origin allow-forms"
      style="width: 100%; height: 100%; border: 0; background: transparent;"
    ></iframe>
  </section>

  <script is:inline>
    (function () {
      const iframe = document.querySelector(
        `iframe[title="${configuration.title}"]`
      );
      if (!iframe) return;

      const targetOrigin = window.location.origin; // same-origin admin UI

      function postContext() {
        // Provide only minimal, non-sensitive context
        const context = {
          type: "parent-context",
          path: window.location.pathname,
          query: window.location.search,
          hash: window.location.hash,
        };
        try {
          iframe.contentWindow?.postMessage(context, targetOrigin);
        } catch (_) {
          /* no-op */
        }
      }

      // Optional: listen for requests from the embedded UI
      window.addEventListener("message", (event) => {
        if (event.origin !== targetOrigin) return; // strict origin check
        const data = event.data;
        if (!data || typeof data !== "object") return;

        // Simple handshake: child can request context
        if (data.type === "request-parent-context") {
          postContext();
        }
      });

      // Send initial context after iframe loads
      iframe.addEventListener("load", () => {
        postContext();
      });
    })();
  </script>
</BaseLayout>
